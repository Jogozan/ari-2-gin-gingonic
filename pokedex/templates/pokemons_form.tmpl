{{ template "layout" . }}

<h1>{{ .title }}</h1>

<div id="errors" style="color:red;">
    {{ range .errors }}
        <div>{{ . }}</div>
    {{ end }}
</div>

<form id="pokemonForm">
    <div>
        <label>Nom :</label>
        <input type="text" id="name" value="{{ .input.Name }}">
        <div class="field-error" data-field="Name" style="color:red;"></div>
    </div>

    <div>
        <label>Base XP :</label>
        <input type="number" id="baseExperience" value="{{ .input.BaseExperience }}">
        <div class="field-error" data-field="BaseExperience" style="color:red;"></div>
    </div>

    <div>
        <label>Poids :</label>
        <input type="number" id="weight" value="{{ .input.Weight }}">
        <div class="field-error" data-field="Weight" style="color:red;"></div>
    </div>

    <div>
        <label>Taille :</label>
        <input type="number" id="height" value="{{ .input.Height }}">
        <div class="field-error" data-field="Height" style="color:red;"></div>
    </div>

    <div>
        <label>Types (s√©par√©s par des virgules) :</label>
        <input type="text" id="types" value="{{ join .input.Types "," }}">
        <div class="field-error" data-field="Types" style="color:red;"></div>
    </div>

    <fieldset>
        <legend>Stats</legend>
        <div>
            <label>HP :</label>
            <input type="number" id="hp" value="{{ .input.Stats.HP }}">
            <div class="field-error" data-field="Stats.HP" style="color:red;"></div>
        </div>
        <div>
            <label>Attaque :</label>
            <input type="number" id="attack" value="{{ .input.Stats.Attack }}">
            <div class="field-error" data-field="Stats.Attack" style="color:red;"></div>
        </div>
        <div>
            <label>D√©fense :</label>
            <input type="number" id="defense" value="{{ .input.Stats.Defense }}">
            <div class="field-error" data-field="Stats.Defense" style="color:red;"></div>
        </div>
        <div>
            <label>Vitesse :</label>
            <input type="number" id="speed" value="{{ .input.Stats.Speed }}">
            <div class="field-error" data-field="Stats.Speed" style="color:red;"></div>
        </div>
    </fieldset>

    <fieldset>
        <legend>Sprites</legend>
        <div>
            <label>Sprite avant (URL) :</label>
            <input type="text" id="front_default" value="{{ .input.Sprites.FrontDefault }}">
            <div class="field-error" data-field="Sprites.FrontDefault" style="color:red;"></div>
        </div>
        <div>
            <label>Sprite arri√®re (URL) :</label>
            <input type="text" id="back_default" value="{{ .input.Sprites.BackDefault }}">
            <div class="field-error" data-field="Sprites.BackDefault" style="color:red;"></div>
        </div>
    </fieldset>

    <button type="submit">Cr√©er</button>
</form>

<pre id="result" style="margin-top:20px; background:#eee; padding:10px;"></pre>

<script>
// Formateur d'erreurs personnalis√©es
const errorMessages = {
    "Name": "Veuillez renseigner un nom",
    "BaseExperience": "Veuillez renseigner l'exp√©rience de base",
    "Weight": "Veuillez renseigner le poids",
    "Height": "Veuillez renseigner la taille",
    "Types": "Veuillez renseigner 1 ou 2 types valides",
    "Stats.HP": "Veuillez renseigner les HP",
    "Stats.Attack": "Veuillez renseigner l'attaque",
    "Stats.Defense": "Veuillez renseigner la d√©fense",
    "Stats.Speed": "Veuillez renseigner la vitesse",
    "Sprites.FrontDefault": "Veuillez renseigner un sprite avant",
    "Sprites.BackDefault": "Veuillez renseigner un sprite arri√®re"
};

function formatErrorMessage(field, message) {
    if (errorMessages[field]) {
        return errorMessages[field];
    }
    return message;
}

document.getElementById("pokemonForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const payload = {
        name: document.getElementById("name").value,
        baseExperience: Number(document.getElementById("baseExperience").value),
        weight: Number(document.getElementById("weight").value),
        height: Number(document.getElementById("height").value),
        types: document.getElementById("types").value.split(",").map(t => t.trim()),
        stats: {
            hp: Number(document.getElementById("hp").value),
            attack: Number(document.getElementById("attack").value),
            defense: Number(document.getElementById("defense").value),
            speed: Number(document.getElementById("speed").value)
        },
        sprites: {
            front_default: document.getElementById("front_default").value,
            back_default: document.getElementById("back_default").value
        }
    };

    const res = await fetch("/pokemons", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    const resultEl = document.getElementById("result");

    // Nettoyer les erreurs pr√©c√©dentes
    document.querySelectorAll(".field-error").forEach(el => el.textContent = "");

    if (!res.ok) {
        const errorData = await res.json();

        // --- üî• Nouveau : parsing des erreurs du backend ---
        if (errorData.error && typeof errorData.error === "string") {
            const lines = errorData.error.split("\n");

            lines.forEach(line => {
                const match = line.match(/'CreatePokemonInput\.([^.']+)'/);
                if (match) {
                    const field = match[1]; // ex: Name
                    const errorEl = document.querySelector(`[data-field="${field}"]`);
                    if (errorEl) {
                        errorEl.textContent = formatErrorMessage(field, line);
                    }
                }
            });

            resultEl.textContent = "Veuillez corriger les erreurs ci-dessus.";
            return;
        }

        // Si le backend renvoie d√©j√† { errors: {} }
        if (errorData.errors && typeof errorData.errors === "object") {
            Object.entries(errorData.errors).forEach(([field, message]) => {
                const errorEl = document.querySelector(`[data-field="${field}"]`);
                if (errorEl) {
                    errorEl.textContent = formatErrorMessage(field, message);
                }
            });
            resultEl.textContent = "Veuillez corriger les erreurs ci-dessus.";
        }
        return;
    }

    const data = await res.json();
    resultEl.textContent = JSON.stringify(data, null, 2);
});
</script>
